{% load static i18n ui component_tags %}

{% component "settings_page"
    title=_("Invoicing Settings")
    subtitle=_("Configure invoicing module behavior and company data")
    module_id="invoicing"
    current_view="settings"
    alpine_app="settingsApp" %}

    {% fill "settings" %}
        {% component "setting_section" title=_("Company Information") description=_("This information will appear on your invoices") %}
            {% component "setting_input"
                name="company_name"
                title=_("Company Name")
                description=_("Your business name for invoices")
                value=config.company_name
                type="text"
                placeholder="Your Company Name" %}{% endcomponent %}

            {% component "setting_input"
                name="company_tax_id"
                title=_("Tax ID (NIF/CIF)")
                description=_("Tax identification number")
                value=config.company_tax_id
                type="text"
                placeholder="B12345678" %}{% endcomponent %}

            {% component "setting_textarea"
                name="company_address"
                title=_("Address")
                description=_("Company address for invoices")
                value=config.company_address
                placeholder="Street, City, Postal Code"
                rows=2 %}{% endcomponent %}

            {% component "setting_input"
                name="company_phone"
                title=_("Phone")
                description=_("Contact phone number")
                value=config.company_phone
                type="tel"
                placeholder="+34 600 000 000" %}{% endcomponent %}

            {% component "setting_input"
                name="company_email"
                title=_("Email")
                description=_("Contact email address")
                value=config.company_email
                type="email"
                placeholder="info@company.com" %}{% endcomponent %}
        {% endcomponent %}

        {% component "setting_section" title=_("Invoice Settings") %}
            {% component "setting_select"
                name="default_series"
                title=_("Default Series")
                description=_("Series used for new invoices")
                value=config.default_series
                options=series_options
                placeholder="Select series" %}{% endcomponent %}

            {% component "setting_toggle"
                name="auto_generate_invoice"
                title=_("Auto Generate Invoice")
                description=_("Automatically create invoice after sale")
                checked=config.auto_generate_invoice %}{% endcomponent %}

            {% component "setting_toggle"
                name="require_customer"
                title=_("Require Customer")
                description=_("Customer is mandatory for invoices")
                checked=config.require_customer
                color="warning" %}{% endcomponent %}
        {% endcomponent %}

        {% component "setting_section" title=_("Invoice Footer") description=_("Text that appears at the bottom of invoices") %}
            {% component "setting_textarea"
                name="invoice_footer"
                title=_("Footer Text")
                description=_("Payment terms, legal information, thank you message")
                value=config.invoice_footer
                placeholder="Payment terms, legal information, thank you message..."
                rows=3 %}{% endcomponent %}
        {% endcomponent %}
    {% endfill %}

    {% fill "actions" %}
        <div class="mt-lg pt-md" style="border-top: 1px solid var(--border-color);">
            <ion-button
                color="medium"
                fill="outline"
                expand="block"
                @click="resetToDefaults()">
                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                {% trans "Reset to Defaults" %}
            </ion-button>
        </div>

        <!-- Info Section -->
        <div class="mt-md p-md rounded-lg" style="background: var(--ion-color-step-50);">
            <div class="flex items-start gap-2">
                <ion-icon name="information-circle-outline" style="font-size: 20px; color: var(--ion-color-primary); margin-top: 2px;"></ion-icon>
                <p class="text-sm m-0" style="color: var(--ion-color-medium);">
                    {% trans "Company information will be displayed on all invoices. Make sure the Tax ID is correct for legal compliance. To manage invoice series, go to the Series tab." %}
                </p>
            </div>
        </div>
    {% endfill %}
{% endcomponent %}

<script>
function settingsApp() {
    return {
        settings: {
            company_name: "{{ config.company_name|escapejs }}",
            company_tax_id: "{{ config.company_tax_id|escapejs }}",
            company_address: "{{ config.company_address|escapejs }}",
            company_phone: "{{ config.company_phone|escapejs }}",
            company_email: "{{ config.company_email|escapejs }}",
            default_series: "{{ config.default_series|escapejs }}",
            auto_generate_invoice: {{ config.auto_generate_invoice|yesno:"true,false" }},
            require_customer: {{ config.require_customer|yesno:"true,false" }},
            invoice_footer: "{{ config.invoice_footer|escapejs }}"
        },

        init() {
            this.$nextTick(() => {
                // Toggles
                this.setupToggle('toggle_auto_generate_invoice', 'auto_generate_invoice');
                this.setupToggle('toggle_require_customer', 'require_customer');

                // Text inputs
                this.setupInput('input_company_name', 'company_name', 'string');
                this.setupInput('input_company_tax_id', 'company_tax_id', 'string');
                this.setupInput('input_company_phone', 'company_phone', 'string');
                this.setupInput('input_company_email', 'company_email', 'string');

                // Textareas
                this.setupTextarea('textarea_company_address', 'company_address');
                this.setupTextarea('textarea_invoice_footer', 'invoice_footer');

                // Select
                this.setupSelect('select_default_series', 'default_series');
            });
        },

        setupToggle(refName, settingKey) {
            const toggle = this.$refs[refName];
            if (toggle) {
                toggle.addEventListener('ionChange', (e) => {
                    this.updateSetting(settingKey, e.detail.checked);
                });
            }
        },

        setupInput(refName, settingKey, type = 'string') {
            const input = this.$refs[refName];
            if (input) {
                input.addEventListener('ionChange', (e) => {
                    let value = e.detail.value;
                    if (type === 'int') {
                        value = parseInt(value) || 0;
                    } else if (type === 'decimal') {
                        value = parseFloat(value) || 0;
                    }
                    this.updateSetting(settingKey, value);
                });
            }
        },

        setupTextarea(refName, settingKey) {
            const textarea = this.$refs[refName];
            if (textarea) {
                textarea.addEventListener('ionChange', (e) => {
                    this.updateSetting(settingKey, e.detail.value || '');
                });
            }
        },

        setupSelect(refName, settingKey) {
            const select = this.$refs[refName];
            if (select) {
                select.addEventListener('ionChange', (e) => {
                    this.updateSetting(settingKey, e.detail.value);
                });
            }
        },

        async updateSetting(key, value) {
            this.settings[key] = value;

            try {
                const response = await fetch('{% url "invoicing:settings_save" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': Alpine.store('ui').getCsrfToken()
                    },
                    body: JSON.stringify(this.settings)
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    Alpine.store('ui').success('{% trans "Settings saved" %}');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                Alpine.store('ui').error('{% trans "Error saving settings" %}');
            }
        },

        async resetToDefaults() {
            this.settings = {
                company_name: '',
                company_tax_id: '',
                company_address: '',
                company_phone: '',
                company_email: '',
                default_series: 'F',
                auto_generate_invoice: false,
                require_customer: false,
                invoice_footer: ''
            };

            try {
                const response = await fetch('{% url "invoicing:settings_save" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': Alpine.store('ui').getCsrfToken()
                    },
                    body: JSON.stringify(this.settings)
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    Alpine.store('ui').toast('{% trans "Settings reset to defaults" %}', 'warning');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                Alpine.store('ui').error('{% trans "Error resetting settings" %}');
            }
        }
    }
}
</script>
