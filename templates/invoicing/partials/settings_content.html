{% load static %}
{% load i18n %}

{% if request.htmx %}
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "invoicing/partials/tabbar.html" with current_view='settings' %}
</ion-footer>
</div>
{% endif %}

{% csrf_token %}
<div x-data="settingsApp()" class="ion-padding">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold" style="color: var(--ion-text-color);">{% trans "Invoicing Settings" %}</h1>
        <p class="text-sm mt-1" style="color: var(--ion-color-medium);">{% trans "Configure invoicing module behavior and company data" %}</p>
    </div>

    <!-- Company Information -->
    <ion-card class="m-0 mb-4">
        <ion-card-header>
            <ion-card-title>{% trans "Company Information" %}</ion-card-title>
            <ion-card-subtitle>{% trans "This information will appear on your invoices" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <form id="settings-form" method="POST">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ion-item>
                        <ion-input
                            name="company_name"
                            label="{% trans 'Company Name' %}"
                            label-placement="stacked"
                            value="{{ config.company_name }}"
                            placeholder="{% trans 'Your Company Name' %}">
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="company_tax_id"
                            label="{% trans 'Tax ID (NIF/CIF)' %}"
                            label-placement="stacked"
                            value="{{ config.company_tax_id }}"
                            placeholder="B12345678">
                        </ion-input>
                    </ion-item>
                    <ion-item class="md:col-span-2">
                        <ion-textarea
                            name="company_address"
                            label="{% trans 'Address' %}"
                            label-placement="stacked"
                            rows="2"
                            placeholder="{% trans 'Street, City, Postal Code' %}">{{ config.company_address }}</ion-textarea>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="company_phone"
                            label="{% trans 'Phone' %}"
                            label-placement="stacked"
                            type="tel"
                            value="{{ config.company_phone }}"
                            placeholder="+34 600 000 000">
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="company_email"
                            label="{% trans 'Email' %}"
                            label-placement="stacked"
                            type="email"
                            value="{{ config.company_email }}"
                            placeholder="info@company.com">
                        </ion-input>
                    </ion-item>
                </div>
            </form>
        </ion-card-content>
    </ion-card>

    <!-- Invoice Settings -->
    <ion-card class="m-0 mb-4">
        <ion-card-header>
            <ion-card-title>{% trans "Invoice Settings" %}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <div class="space-y-4">
                <!-- Default Series -->
                <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                    <div>
                        <h3 class="font-medium">{% trans "Default Series" %}</h3>
                        <p class="text-sm text-medium">{% trans "Series used for new invoices" %}</p>
                    </div>
                    <ion-select
                        name="default_series"
                        interface="popover"
                        value="{{ config.default_series }}"
                        form="settings-form">
                        {% for series in series_list %}
                        <ion-select-option value="{{ series.prefix }}">{{ series.prefix }} - {{ series.name }}</ion-select-option>
                        {% empty %}
                        <ion-select-option value="F">F - {% trans "Default" %}</ion-select-option>
                        {% endfor %}
                    </ion-select>
                </div>

                <!-- Auto Generate Invoice -->
                <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                    <div>
                        <h3 class="font-medium">{% trans "Auto Generate Invoice" %}</h3>
                        <p class="text-sm text-medium">{% trans "Automatically create invoice after sale" %}</p>
                    </div>
                    <ion-toggle
                        name="auto_generate_invoice"
                        form="settings-form"
                        {% if config.auto_generate_invoice %}checked{% endif %}>
                    </ion-toggle>
                </div>

                <!-- Require Customer -->
                <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                    <div>
                        <h3 class="font-medium">{% trans "Require Customer" %}</h3>
                        <p class="text-sm text-medium">{% trans "Customer is mandatory for invoices" %}</p>
                    </div>
                    <ion-toggle
                        name="require_customer"
                        form="settings-form"
                        {% if config.require_customer %}checked{% endif %}>
                    </ion-toggle>
                </div>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Invoice Footer -->
    <ion-card class="m-0 mb-4">
        <ion-card-header>
            <ion-card-title>{% trans "Invoice Footer" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Text that appears at the bottom of invoices" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <ion-textarea
                name="invoice_footer"
                form="settings-form"
                rows="3"
                placeholder="{% trans 'Payment terms, legal information, thank you message...' %}">{{ config.invoice_footer }}</ion-textarea>
        </ion-card-content>
    </ion-card>

    <!-- Save Button -->
    <div class="flex justify-end gap-4">
        <ion-button color="medium" fill="outline" @click="resetForm()">
            <ion-icon slot="start" name="refresh-outline"></ion-icon>
            {% trans "Reset" %}
        </ion-button>
        <ion-button @click="saveSettings()">
            <ion-icon slot="start" name="save-outline"></ion-icon>
            {% trans "Save Settings" %}
        </ion-button>
    </div>

    <!-- Info Section -->
    <div class="mt-6 p-4 rounded-lg" style="background: var(--ion-color-step-50);">
        <div class="flex items-start gap-2">
            <ion-icon name="information-circle-outline" style="font-size: 20px; color: var(--ion-color-primary); margin-top: 2px;"></ion-icon>
            <p class="text-sm" style="color: var(--ion-color-medium);">
                {% trans "Company information will be displayed on all invoices. Make sure the Tax ID is correct for legal compliance. To manage invoice series, go to the Series tab." %}
            </p>
        </div>
    </div>
</div>

<script>
// Register globally for HTMX compatibility
window.settingsApp = function() {
    return {
        async saveSettings() {
            const form = document.getElementById('settings-form');
            const formData = new FormData(form);

            try {
                const response = await fetch('{% url "invoicing:settings" %}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message, 'success');
                } else {
                    this.showToast(data.error, 'danger');
                }
            } catch (error) {
                this.showToast('{% trans "Error saving settings" %}', 'danger');
            }
        },

        resetForm() {
            if (confirm('{% trans "Reset all settings to their original values?" %}')) {
                htmx.ajax('GET', '{% url "invoicing:settings" %}', {target: '#dashboard-content'});
            }
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.color = color;
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    }
};

// Re-initialize Alpine after HTMX swap
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'dashboard-content') {
        const alpineEl = event.detail.target.querySelector('[x-data]');
        if (alpineEl && !alpineEl._x_dataStack) {
            Alpine.initTree(alpineEl);
        }
    }
});
</script>
