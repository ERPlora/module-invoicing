{% load static i18n ui component_tags %}

{% component "page"
    title=_("New Invoice")
    module_id="invoicing"
    tabbar_view="invoices" %}

    {% fill "content" %}
        {% csrf_token %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <!-- Customer Info -->
            <ion-card class="m-0 mb-4">
                <ion-card-header>
                    <ion-card-title>{% trans "Customer Information" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <ion-item>
                            <ion-input
                                id="customer_name"
                                name="customer_name"
                                label="{% trans 'Customer Name' %} *"
                                label-placement="stacked"
                                required>
                            </ion-input>
                        </ion-item>
                        <ion-item>
                            <ion-input
                                id="customer_tax_id"
                                name="customer_tax_id"
                                label="{% trans 'Tax ID (NIF/CIF)' %}"
                                label-placement="stacked">
                            </ion-input>
                        </ion-item>
                        <ion-item class="md:col-span-2">
                            <ion-textarea
                                id="customer_address"
                                name="customer_address"
                                label="{% trans 'Address' %}"
                                label-placement="stacked"
                                rows="2">
                            </ion-textarea>
                        </ion-item>
                        <ion-item>
                            <ion-input
                                id="customer_email"
                                name="customer_email"
                                label="{% trans 'Email' %}"
                                label-placement="stacked"
                                type="email">
                            </ion-input>
                        </ion-item>
                        <ion-item>
                            <ion-input
                                id="customer_phone"
                                name="customer_phone"
                                label="{% trans 'Phone' %}"
                                label-placement="stacked"
                                type="tel">
                            </ion-input>
                        </ion-item>
                    </div>
                </ion-card-content>
            </ion-card>

            <!-- Invoice Lines -->
            <ion-card class="m-0">
                <ion-card-header>
                    <div class="flex justify-between items-center">
                        <ion-card-title>{% trans "Items" %}</ion-card-title>
                        <ion-button size="small" onclick="addLine()">
                            <ion-icon slot="start" name="add-outline"></ion-icon>
                            {% trans "Add Item" %}
                        </ion-button>
                    </div>
                </ion-card-header>
                <ion-card-content class="p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr style="background: var(--ion-color-light);">
                                    <th class="p-3 text-left text-sm font-medium" style="min-width: 200px;">{% trans "Description" %}</th>
                                    <th class="p-3 text-right text-sm font-medium" style="width: 80px;">{% trans "Qty" %}</th>
                                    <th class="p-3 text-right text-sm font-medium" style="width: 100px;">{% trans "Price" %}</th>
                                    <th class="p-3 text-right text-sm font-medium" style="width: 80px;">{% trans "Disc.%" %}</th>
                                    <th class="p-3 text-right text-sm font-medium" style="width: 100px;">{% trans "Total" %}</th>
                                    <th class="p-3 text-center" style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="invoice-lines">
                                <!-- Lines will be added dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="empty-lines-state" class="text-center py-8" style="display: none;">
                        <ion-icon name="document-text-outline" style="font-size: 48px; color: var(--ion-color-medium);"></ion-icon>
                        <p class="mt-2" style="color: var(--ion-color-medium);">{% trans "No items added" %}</p>
                        <ion-button class="mt-4" size="small" onclick="addLine()">
                            <ion-icon slot="start" name="add-outline"></ion-icon>
                            {% trans "Add First Item" %}
                        </ion-button>
                    </div>
                </ion-card-content>
            </ion-card>
        </div>

        <!-- Summary Sidebar -->
        <div>
            <ion-card class="m-0 mb-4">
                <ion-card-header>
                    <ion-card-title>{% trans "Summary" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-medium">{% trans "Subtotal" %}</span>
                            <span>€<span id="subtotal-display">0.00</span></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-medium">{% trans "Tax" %}</span>
                            <div class="flex items-center gap-2">
                                <ion-input
                                    id="tax_rate"
                                    type="number"
                                    value="{{ config.default_tax_rate|default:21 }}"
                                    min="0"
                                    max="100"
                                    step="1"
                                    style="width: 60px;"
                                    class="text-right">
                                </ion-input>
                                <span>%</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medium">{% trans "Tax Amount" %}</span>
                            <span>€<span id="tax-display">0.00</span></span>
                        </div>
                        <div style="height: 1px; background: var(--ion-border-color);"></div>
                        <div class="flex justify-between text-lg font-bold">
                            <span>{% trans "Total" %}</span>
                            <span>€<span id="total-display">0.00</span></span>
                        </div>
                    </div>
                </ion-card-content>
            </ion-card>

            <ion-card class="m-0 mb-4">
                <ion-card-header>
                    <ion-card-title>{% trans "Notes" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <ion-textarea
                        id="invoice_notes"
                        rows="4"
                        placeholder="{% trans 'Optional notes for the invoice...' %}">
                    </ion-textarea>
                </ion-card-content>
            </ion-card>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-3">
                <ion-button expand="block" color="primary" onclick="saveInvoice()">
                    <ion-icon slot="start" name="save-outline"></ion-icon>
                    {% trans "Create Invoice" %}
                </ion-button>
                <ion-button expand="block" fill="outline"
                    hx-get="{% url 'invoicing:invoices' %}"
                    hx-target="#main-content-area"
                    hx-push-url="true">
                    {% trans "Cancel" %}
                </ion-button>
            </div>
        </div>
    </div>
    {% endfill %}
{% endcomponent %}

<script>
(function() {
    var lineIndex = 0;
    var defaultTaxRate = {{ config.default_tax_rate|default:21 }};

    // Add a new line to the invoice
    window.addLine = function() {
        var tbody = document.getElementById('invoice-lines');
        var tr = document.createElement('tr');
        tr.id = 'line-' + lineIndex;
        tr.style.borderBottom = '1px solid var(--ion-border-color)';
        tr.innerHTML = `
            <td class="p-2">
                <ion-input
                    name="line_description_${lineIndex}"
                    class="line-description"
                    placeholder="{% trans 'Description' %}"
                    data-index="${lineIndex}">
                </ion-input>
            </td>
            <td class="p-2">
                <ion-input
                    type="number"
                    name="line_quantity_${lineIndex}"
                    class="line-quantity"
                    data-index="${lineIndex}"
                    value="1"
                    min="1"
                    step="1">
                </ion-input>
            </td>
            <td class="p-2">
                <ion-input
                    type="number"
                    name="line_price_${lineIndex}"
                    class="line-price"
                    data-index="${lineIndex}"
                    value="0"
                    min="0"
                    step="0.01">
                </ion-input>
            </td>
            <td class="p-2">
                <ion-input
                    type="number"
                    name="line_discount_${lineIndex}"
                    class="line-discount"
                    data-index="${lineIndex}"
                    value="0"
                    min="0"
                    max="100"
                    step="1">
                </ion-input>
            </td>
            <td class="p-2 text-right font-medium line-total" data-index="${lineIndex}">
                €0.00
            </td>
            <td class="p-2 text-center">
                <ion-button fill="clear" color="danger" size="small" onclick="removeLine(${lineIndex})">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
            </td>
        `;
        tbody.appendChild(tr);
        lineIndex++;
        updateEmptyState();
        attachLineListeners(tr);
    };

    // Remove a line
    window.removeLine = function(index) {
        var tr = document.getElementById('line-' + index);
        if (tr) {
            tr.remove();
            calculateTotals();
            updateEmptyState();
        }
    };

    // Attach event listeners to line inputs
    function attachLineListeners(tr) {
        var inputs = tr.querySelectorAll('ion-input');
        inputs.forEach(function(input) {
            input.addEventListener('ionChange', function() {
                calculateLineTotal(tr);
                calculateTotals();
            });
        });
    }

    // Calculate line total
    function calculateLineTotal(tr) {
        var qty = parseFloat(tr.querySelector('.line-quantity').value) || 0;
        var price = parseFloat(tr.querySelector('.line-price').value) || 0;
        var discount = parseFloat(tr.querySelector('.line-discount').value) || 0;

        var subtotal = qty * price;
        var discountAmount = subtotal * (discount / 100);
        var total = subtotal - discountAmount;

        tr.querySelector('.line-total').textContent = '€' + total.toFixed(2);
        return total;
    }

    // Calculate all totals
    function calculateTotals() {
        var rows = document.querySelectorAll('#invoice-lines tr');
        var subtotal = 0;

        rows.forEach(function(tr) {
            subtotal += calculateLineTotal(tr);
        });

        var taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
        var tax = subtotal * (taxRate / 100);
        var total = subtotal + tax;

        document.getElementById('subtotal-display').textContent = subtotal.toFixed(2);
        document.getElementById('tax-display').textContent = tax.toFixed(2);
        document.getElementById('total-display').textContent = total.toFixed(2);
    }

    // Update empty state visibility
    function updateEmptyState() {
        var rows = document.querySelectorAll('#invoice-lines tr');
        var emptyState = document.getElementById('empty-lines-state');
        emptyState.style.display = rows.length === 0 ? 'block' : 'none';
    }

    // Save invoice
    window.saveInvoice = async function() {
        var customerName = document.getElementById('customer_name').value;
        if (!customerName) {
            showToast('{% trans "Customer name is required" %}', 'warning');
            return;
        }

        var rows = document.querySelectorAll('#invoice-lines tr');
        if (rows.length === 0) {
            showToast('{% trans "At least one item is required" %}', 'warning');
            return;
        }

        // Build invoice data
        var lines = [];
        rows.forEach(function(tr) {
            lines.push({
                description: tr.querySelector('.line-description').value,
                quantity: parseFloat(tr.querySelector('.line-quantity').value) || 1,
                unit_price: parseFloat(tr.querySelector('.line-price').value) || 0,
                discount: parseFloat(tr.querySelector('.line-discount').value) || 0,
                tax_rate: parseFloat(document.getElementById('tax_rate').value) || 0
            });
        });

        var invoice = {
            customer_name: customerName,
            customer_tax_id: document.getElementById('customer_tax_id').value || '',
            customer_address: document.getElementById('customer_address').value || '',
            customer_email: document.getElementById('customer_email').value || '',
            customer_phone: document.getElementById('customer_phone').value || '',
            tax_rate: parseFloat(document.getElementById('tax_rate').value) || 0,
            notes: document.getElementById('invoice_notes').value || '',
            lines: lines
        };

        try {
            var response = await fetch('{% url "invoicing:invoice_create" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(invoice)
            });

            var data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(function() {
                    htmx.ajax('GET', '/modules/invoicing/invoices/' + data.invoice_id + '/', {target: '#main-content-area'});
                }, 500);
            } else {
                showToast(data.error, 'danger');
            }
        } catch (error) {
            showToast('{% trans "Error saving invoice" %}', 'danger');
        }
    };

    // Toast helper
    async function showToast(message, color) {
        var toast = document.createElement('ion-toast');
        toast.message = message;
        toast.duration = 2000;
        toast.color = color || 'primary';
        toast.position = 'top';
        document.body.appendChild(toast);
        await toast.present();
    }

    // Tax rate change listener
    document.getElementById('tax_rate').addEventListener('ionChange', calculateTotals);

    // Initialize with one line
    addLine();
})();
</script>
