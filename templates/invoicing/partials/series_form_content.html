{% load static %}
{% load i18n %}

<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "invoicing/partials/tabbar.html" with current_view='series' %}
</ion-footer>
</div>

{% csrf_token %}
<div x-data="seriesFormApp()" class="ion-padding">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4">
            <ion-button fill="clear"
                hx-get="{% url 'invoicing:series' %}"
                hx-target="#dashboard-content"
                hx-push-url="true">
                <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
            </ion-button>
            <div>
                <h1 class="text-2xl font-bold" style="color: var(--ion-text-color);">
                    {% if series %}{% trans "Edit Series" %}{% else %}{% trans "New Series" %}{% endif %}
                </h1>
            </div>
        </div>
        <ion-button @click="saveSeries()" color="success">
            <ion-icon slot="start" name="save-outline"></ion-icon>
            {% trans "Save" %}
        </ion-button>
    </div>

    <ion-card class="m-0">
        <ion-card-content>
            <form id="series-form" method="POST">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ion-item>
                        <ion-input
                            name="prefix"
                            label="{% trans 'Prefix' %} *"
                            label-placement="stacked"
                            value="{{ series.prefix|default:'' }}"
                            placeholder="F"
                            maxlength="5"
                            {% if series %}readonly{% endif %}
                            required>
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="name"
                            label="{% trans 'Name' %} *"
                            label-placement="stacked"
                            value="{{ series.name|default:'' }}"
                            placeholder="{% trans 'Invoices' %}"
                            required>
                        </ion-input>
                    </ion-item>
                    <ion-item class="md:col-span-2">
                        <ion-textarea
                            name="description"
                            label="{% trans 'Description' %}"
                            label-placement="stacked"
                            rows="2"
                            placeholder="{% trans 'Optional description...' %}">{{ series.description|default:'' }}</ion-textarea>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="number_digits"
                            type="number"
                            label="{% trans 'Number Digits' %}"
                            label-placement="stacked"
                            value="{{ series.number_digits|default:6 }}"
                            min="4"
                            max="10">
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-label>{% trans "Preview" %}</ion-label>
                        <ion-note slot="end" style="font-family: monospace; font-size: 1.1em;">
                            {{ series.prefix|default:'F' }}{{ series.current_number|default:1|stringformat:"06d" }}
                        </ion-note>
                    </ion-item>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <h3 class="font-medium">{% trans "Active" %}</h3>
                            <p class="text-sm text-medium">{% trans "Allow creating invoices with this series" %}</p>
                        </div>
                        <ion-toggle
                            name="is_active"
                            {% if series.is_active or not series %}checked{% endif %}>
                        </ion-toggle>
                    </div>

                    <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <h3 class="font-medium">{% trans "Default" %}</h3>
                            <p class="text-sm text-medium">{% trans "Use as default series for new invoices" %}</p>
                        </div>
                        <ion-toggle
                            name="is_default"
                            {% if series.is_default %}checked{% endif %}>
                        </ion-toggle>
                    </div>
                </div>
            </form>
        </ion-card-content>
    </ion-card>
</div>

<script>
// Register globally for HTMX compatibility
window.seriesFormApp = function() {
    return {
        async saveSeries() {
            const form = document.getElementById('series-form');
            const formData = new FormData(form);

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message, 'success');
                    setTimeout(() => {
                        htmx.ajax('GET', '{% url "invoicing:series" %}', {target: '#dashboard-content'});
                    }, 500);
                } else {
                    this.showToast(data.error, 'danger');
                }
            } catch (error) {
                this.showToast('{% trans "Error saving series" %}', 'danger');
            }
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.color = color;
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    }
};

// Re-initialize Alpine after HTMX swap
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'dashboard-content') {
        const alpineEl = event.detail.target.querySelector('[x-data]');
        if (alpineEl && !alpineEl._x_dataStack) {
            Alpine.initTree(alpineEl);
        }
    }
});
</script>
