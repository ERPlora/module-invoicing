{% load static i18n ui component_tags %}

{# Toast listener for HX-Trigger events #}
<script>
(function() {
    if (!window._invoicingToastListenerAdded) {
        window._invoicingToastListenerAdded = true;
        document.body.addEventListener('showToast', function(e) {
            var detail = e.detail || {};
            var message = detail.message || 'Done';
            var color = detail.color || 'success';

            var toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.position = 'top';
            toast.color = color;
            document.body.appendChild(toast);
            toast.present();
        });
    }
})();
</script>

{% with form_title=series|yesno:_("Edit Series"),_("New Series") %}
{% component "page"
    title=form_title
    module_id="invoicing"
    tabbar_view="series" %}

    {% fill "content" %}
    <ion-card class="m-0">
        <ion-card-content>
            <form id="series-form"
                  method="POST"
                  hx-post=""
                  hx-target="#main-content-area"
                  hx-push-url="{% url 'invoicing:series' %}">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ion-item>
                        <ion-input
                            name="prefix"
                            label="{% trans 'Prefix' %} *"
                            label-placement="stacked"
                            value="{{ series.prefix|default:'' }}"
                            placeholder="F"
                            maxlength="5"
                            {% if series %}readonly{% endif %}
                            required>
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="name"
                            label="{% trans 'Name' %} *"
                            label-placement="stacked"
                            value="{{ series.name|default:'' }}"
                            placeholder="{% trans 'Invoices' %}"
                            required>
                        </ion-input>
                    </ion-item>
                    <ion-item class="md:col-span-2">
                        <ion-textarea
                            name="description"
                            label="{% trans 'Description' %}"
                            label-placement="stacked"
                            rows="2"
                            placeholder="{% trans 'Optional description...' %}">{{ series.description|default:'' }}</ion-textarea>
                    </ion-item>
                    <ion-item>
                        <ion-input
                            name="number_digits"
                            type="number"
                            label="{% trans 'Number Digits' %}"
                            label-placement="stacked"
                            value="{{ series.number_digits|default:6 }}"
                            min="4"
                            max="10">
                        </ion-input>
                    </ion-item>
                    <ion-item>
                        <ion-label>{% trans "Preview" %}</ion-label>
                        <ion-note slot="end" style="font-family: monospace; font-size: 1.1em;">
                            {{ series.prefix|default:'F' }}{{ series.current_number|default:1|stringformat:"06d" }}
                        </ion-note>
                    </ion-item>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <h3 class="font-medium">{% trans "Active" %}</h3>
                            <p class="text-sm text-medium">{% trans "Allow creating invoices with this series" %}</p>
                        </div>
                        <ion-toggle
                            name="is_active"
                            {% if series.is_active or not series %}checked{% endif %}>
                        </ion-toggle>
                    </div>

                    <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <h3 class="font-medium">{% trans "Default" %}</h3>
                            <p class="text-sm text-medium">{% trans "Use as default series for new invoices" %}</p>
                        </div>
                        <ion-toggle
                            name="is_default"
                            {% if series.is_default %}checked{% endif %}>
                        </ion-toggle>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6 flex gap-3">
                    <ion-button
                        hx-get="{% url 'invoicing:series' %}"
                        hx-target="#main-content-area"
                        hx-push-url="true"
                        fill="outline"
                        expand="block"
                        class="flex-1">
                        {% trans "Cancel" %}
                    </ion-button>
                    <ion-button
                        type="submit"
                        expand="block"
                        color="primary"
                        class="flex-1">
                        <ion-icon slot="start" name="save-outline"></ion-icon>
                        {% trans "Save" %}
                    </ion-button>
                </div>
            </form>
        </ion-card-content>
    </ion-card>
    {% endfill %}
{% endcomponent %}
{% endwith %}
