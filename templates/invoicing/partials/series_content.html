{% load static i18n ui component_tags %}

{% if request.htmx %}
{% component "tabbar" module_id="invoicing" current_view="series" oob=True %}{% endcomponent %}
{% endif %}

{% ui_page_header title=_("Invoice Series") action_icon="add-outline" action_label=_("New Series") action_hx_get="/modules/invoicing/series/create/" action_hx_target="#main-content-area" action_hx_push_url="true" %}

{% csrf_token %}
<div x-data="seriesApp()" class="ion-padding">

    <!-- Series List -->
    <ion-card class="m-0">
        <ion-card-content class="p-0">
            <ion-list lines="full">
                {% for series in series_list %}
                <ion-item>
                    <div slot="start" class="w-12 h-12 flex items-center justify-center rounded-lg font-bold text-lg" style="background: var(--ion-color-primary-tint); color: var(--ion-color-primary);">
                        {{ series.prefix }}
                    </div>
                    <ion-label>
                        <h2>{{ series.name }}</h2>
                        <p>{{ series.description|default:_("No description") }}</p>
                        <p class="text-xs">
                            {% trans "Next number" %}: {{ series.prefix }}{{ series.current_number|stringformat:"06d" }}
                        </p>
                    </ion-label>
                    <div slot="end" class="flex items-center gap-2">
                        {% if series.is_default %}
                        <ion-badge color="primary">{% trans "Default" %}</ion-badge>
                        {% endif %}
                        {% if not series.is_active %}
                        <ion-badge color="medium">{% trans "Inactive" %}</ion-badge>
                        {% endif %}
                        <ion-button fill="clear" size="small"
                            hx-get="{% url 'invoicing:series_edit' series.id %}"
                            hx-target="#main-content-area"
                            hx-push-url="true">
                            <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                        </ion-button>
                        <ion-button fill="clear" color="danger" size="small"
                            @click="deleteSeries({{ series.id }}, '{{ series.prefix }}')">
                            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                        </ion-button>
                    </div>
                </ion-item>
                {% empty %}
                <ion-item>
                    <ion-label class="text-center py-8">
                        <ion-icon name="list-outline" style="font-size: 48px; color: var(--ion-color-medium);"></ion-icon>
                        <p class="mt-2" style="color: var(--ion-color-medium);">{% trans "No series created" %}</p>
                    </ion-label>
                </ion-item>
                {% endfor %}
            </ion-list>
        </ion-card-content>
    </ion-card>

    <!-- Info -->
    <div class="mt-6 p-4 rounded-lg" style="background: var(--ion-color-step-50);">
        <div class="flex items-start gap-2">
            <ion-icon name="information-circle-outline" style="font-size: 20px; color: var(--ion-color-primary); margin-top: 2px;"></ion-icon>
            <p class="text-sm" style="color: var(--ion-color-medium);">
                {% trans "Invoice series allow you to have different numbering sequences for different types of invoices. Each series has its own prefix (e.g., F for invoices, R for receipts) and auto-incrementing number." %}
            </p>
        </div>
    </div>
</div>

<script>
// Register globally for HTMX compatibility
window.seriesApp = function() {
    return {
        async deleteSeries(id, prefix) {
            if (!confirm(`{% trans "Delete series" %} ${prefix}? {% trans "This action cannot be undone." %}`)) return;

            try {
                const response = await fetch(`/modules/invoicing/series/${id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message, 'success');
                    setTimeout(() => htmx.ajax('GET', '{% url "invoicing:series" %}', {target: '#dashboard-content'}), 1000);
                } else {
                    this.showToast(data.error, 'danger');
                }
            } catch (error) {
                this.showToast('{% trans "Error deleting series" %}', 'danger');
            }
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.color = color;
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    }
};

// Re-initialize Alpine after HTMX settles (ensures scripts have executed)
document.addEventListener('htmx:afterSettle', function(event) {
    if (event.detail.target.id === 'dashboard-content') {
        const alpineEl = event.detail.target.querySelector('[x-data]');
        if (alpineEl && !alpineEl._x_dataStack) {
            Alpine.initTree(alpineEl);
        }
    }
});
</script>
